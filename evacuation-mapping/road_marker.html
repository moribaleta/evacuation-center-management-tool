<!DOCTYPE html>
<html>
<head>
    <title>Map Maker</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            z-index: 0;
        }
    </style>
    <script type="text/javascript" src="resources/json/coordinates.json"></script>
    <script type="text/javascript" src="resources/json/hospitals.json"></script>
    <script src="resources/js/jquery-3.0.0.min.js"></script>
    <script src="resources/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="resources/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="resources/css/main.css">
</head>
<body>
    
    <nav class="navbar navbar-inverse" id="navbar">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span> 
                </button>
                <a class="navbar-brand" href="#">iEvacuate Map Maker</a>
            </div>
        </div>
    </nav>
    
    <div  id="myModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generated Coordinates</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h4>current path</h4>
                    <p id="path_value"></p>
                    <blank></blank>
                    <h4>saved paths</h4>
                    <p id="road_value"></p>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="savePath()">Save</button>
                    <button type="button" class="btn btn-primary" onclick="printPath()">Save & Print</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    
    <div id="map"></div>   
    <!-- Modal -->
    <div class="bottom-container">
        <button class="bottom-button" id="button_add_new" onclick="addNewPath()">add path</button>
        <button class="bottom-button" id="button_add_new" onclick="showPath()">show paths</button>
        <button class="bottom-button" id="button_reload" onclick="resetMarker()">back</button>
    </div>
    
    <script src="resources/json/road_coordinates2.json"></script>
    
    <script>
        var map;
        
        var infowindow;
        var directionsService;
        var emergency_marker = [];
        var hostpital_list = hospital_data;
        
        var road_map = []//[{"name":"path1","coordinates":[{"id":"path10","lat":14.422914527194624,"lng":121.44419080942102},{"id":"path11","lat":14.422800229442972,"lng":121.4443866106791},{"id":"path12","lat":14.422675540919757,"lng":121.44464678495355},{"id":"path13","lat":14.42253526624771,"lng":121.44485599725671},{"id":"path14","lat":14.42233784248559,"lng":121.44520200221963},{"id":"path15","lat":14.422189547260968,"lng":121.44545482052968},{"id":"path16","lat":14.421999916251135,"lng":121.44581691874669}]},{"name":"path2","coordinates":[{"id":"path20","lat":14.422697611686434,"lng":121.4446606617842},{"id":"path21","lat":14.42284568308532,"lng":121.44473576363661},{"id":"path22","lat":14.423004141283892,"lng":121.44481086548903},{"id":"path23","lat":14.423174288896206,"lng":121.44490608390906},{"id":"path24","lat":14.42331130997852,"lng":121.44497681772594}]}]
        
        var path = {
            name: null,
            coordinates: [
            ]
        }
        
        var emergency_mark = {
            id: null, 
            marker: null,
            location: {}
        }
        
        function resetMarker(){
            path.name = null;
            
            path.coordinates = [];
            initMap();
            //map.clearOverlays();
        }
        
        function addNewPath(){
            road_map.push(JSON.parse(JSON.stringify(path)))
            path = {
                name: null,
                coordinates: []
            }
            alert("you can now create a new path")
        }
        
        
        
        function showPath(){
            /* road_map.push(JSON.parse(JSON.stringify(path)))
            path = {
                name: null,
                coordinates: []
            } */
            
            var textPath = JSON.stringify(path)
            var textRoad = JSON.stringify(road_map)
            $('#myModal').modal('show');
            $('#road_value').html(textRoad)
            $('#path_value').html(textPath)
        }
        
        function savePath() {
            if(path.name != null || path.coordinates.length > 0) {
                road_map.push(JSON.parse(JSON.stringify(path)))
                path = {
                    name: null,
                    coordinates: []
                }
            }
            
            road_map = optimizeMap()
            

            var text = JSON.stringify(road_map)
            localStorage.setItem("roads", text)
            //$('#myModal').modal('show');
            $('#road_value').html(text)
            //$('#path_value').html(textPath)
        }
        
        function getdistance(lat1, lat2, lon1, lon2) {
            var p = 0.017453292519943295; // Math.PI / 180
            var c = Math.cos;
            var a = 0.5 - c((lat2 - lat1) * p) / 2 +
            c(lat1 * p) * c(lat2 * p) *
            (1 - c((lon2 - lon1) * p)) / 2;
            
            return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
        }
        
        function optimizeMap() {
            var coordinates = []
            road_map.forEach((val) => {
                //coordinates.push(val.coordinates)
                //coordinates = coordinates.concat(val.coordinates)
                coordinates.push(...val.coordinates)
            })
            console.log("road_map %o", road_map)
            console.log("coordinates %o", coordinates)
            var coordinates2 = [...coordinates]
            
            coordinates.forEach((value_1, index_1) => {
                coordinates2.forEach((value_2, index_2) => {
                    let distance = getdistance(
                    value_1.lat, value_2.lat,
                    value_1.lng, value_2.lng)
                    console.log("distance %o", distance)
                    if (distance < 0.03) {
                        coordinates2[index_2].lat = value_1.lat
                        coordinates2[index_2].lng = value_1.lng
                        console.log("hey im low, val1: %o vs val2: %o", value_1, value_2)
                    }  
                })
            })
            
            let optimized = road_map.map((path, index) => {
                coordinates2.forEach((coord) => {
                    path.coordinates.forEach((coord2, index2) => {
                        if (coord2.id == coord.id) {
                            path.coordinates[index2] = coord
                        }
                    })
                })
                return path
            })
            
            return optimized
            
        }
        
        
        
        function printPath(){
            if(path.name != null || path.coordinates.length > 0) {
                road_map.push(JSON.parse(JSON.stringify(path)))
                path = {
                    name: null,
                    coordinates: []
                }
            }

            road_map = optimizeMap()

            var text = JSON.stringify(road_map)

            localStorage.setItem("roads", text)
            saveTextAsFile(text)
        }
        
        function saveTextAsFile(text) {
            const textToWrite = text
            const textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
            const fileNameToSaveAs = "coordinates.json"//document.getElementById("").value;
            let downloadLink = document.createElement("a");
            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "Download File";
            if (window.webkitURL != null)
            {
                // Chrome allows the link to be clicked
                // without actually adding it to the DOM.
                downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
            }
            else
            {
                // Firefox requires the link to be added to the DOM
                // before it can be clicked.
                downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                downloadLink.onclick = destroyClickedElement;
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
            }
            
            downloadLink.click();
        }
        
        function initMap() {
            
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                disableDefaultUI: true,
                draggableCursor:'crosshair',
                styles: [
                {
                    featureType: 'all',
                    stylers: [
                    { saturation: -80 }
                    ]
                },{
                    featureType: 'road.arterial',
                    elementType: 'geometry',
                    stylers: [
                    { hue: '#00ffee' },
                    { saturation: 50 }
                    ]
                }
                ]
            });
            
            
            
            var bounds = new google.maps.LatLngBounds();
            
            google.maps.event.addListener(map, 'click', function(e) {
                if (confirm("Do you want to add a road icon here?") ) {
                    placeMarker(e.latLng, map);
                }
            });
            
            var lineSymbol = {
                path: 'M 0,-1 0,1',
                strokeOpacity: 1,
                scale: 4
            };
            
            var infoWindow = new google.maps.InfoWindow(), marker, i;
            for( i = 0; i < hostpital_list.length; i++ ) {
                var position = new google.maps.LatLng( hostpital_list[i].location.lat,hostpital_list[i].location.long);
                bounds.extend(position);
                
                marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: hostpital_list[i].name,
                    icon: 'resources/images/hospital_32.png'
                });
                
                map.fitBounds(bounds);
            }
            
            var boundsListener = google.maps.event.addListener((map), 'bounds_changed', function(event) {
                this.setZoom(14);
                google.maps.event.removeListener(boundsListener);
            });
            
            var line = new google.maps.Polyline({
                path: coords,
                strokeOpacity: 0,
                icons: [{
                    icon: lineSymbol,
                    offset: '0',
                    repeat: '20px'
                }],
                map: map
            });
            
            initPrevMarkers(map)
        }
        
        function clearMarkers() {
            setMapOnAll(null);
            initMap();
        }
        
        function removeMarker(marker){
            //emergency_marker.splice(position,1);
            
            /* emergency_marker.filter((value) => {
                return (position.lat() == value.position.lat() && position.lng() == value.position.lng())
            }).forEach((marker) => {
                marker.setMap(null)
            }) */
            marker.marker.setMap(null)
            const marker_location = marker.location
            
            emergency_marker = emergency_marker.filter((value) => {
                return (marker.id != value.id)
            })
            
            road_map.forEach((road, index) => {
                let filter_coords = road.coordinates.filter((value) => {
                    return !(value.lat == marker_location.lat && value.lng == marker_location.lng)
                })
                road_map[index].coordinates = filter_coords
            })
            
            
            let filter_coords = path.coordinates.filter((value) => {
                return !(value.lat == marker_location.lat && value.lng == marker_location.lng)
            })
            path.coordinates = filter_coords
            
            console.log(path)
        }
        
        function placeMarker(position, map) {
            if(path.name==null){
                path.name = prompt("enter road name");
            }
            var location = {
                id : path.name + path.coordinates.length || 0,
                lat: position.lat(),
                lng: position.lng()
            }
            
            path.coordinates.push(location);
            
            
            console.log(""+JSON.stringify(path));
            
            var emergencymarker = new google.maps.Marker({
                position: position,
                map: map,
                icon: 'resources/images/border-dot-point-25.png',
            });
            
            let marker      = {...emergency_mark}
            marker.id       = path.name + location.id
            marker.marker   = emergencymarker
            marker.location = {...location}
            
            console.log("position: "+position);
            emergency_marker.push(marker);
            
            google.maps.event.addListener(emergencymarker, 'click', function() {
                if ((path.name == null) && (confirm("start path here?"))) {
                    path.name = prompt("enter road name");
                    var location = {
                        id : path.coordinates.length || 0,
                        lat: position.lat(),
                        lng: position.lng()
                    }
                    path.coordinates.push(location);
                } else if (confirm("do you want to delete this?")) {
                    removeMarker(marker)
                }
            });
            
            
        }
        
        function initPrevMarkers(map) {
            /* road_map = localStorage.getItem("roads")
            console.log("road %o", road_map) */
            road_map = JSON.parse(localStorage.getItem('roads')) || []
            
            road_map.forEach((path) => {
                path.coordinates.forEach((coord) => {
                    placeMarkerPrev(coord, map)
                })
            })
        }
        
        ///placed previous marker
        function placeMarkerPrev(coordinates, map) {
            
            var position = new google.maps.LatLng(coordinates.lat, coordinates.lng);
            
            var location = {
                id : coordinates.id,
                lat: coordinates.lat,
                lng: coordinates.lng
            }
            
            //path.coordinates.push(location);
            
            
            console.log(""+JSON.stringify(path));
            
            var emergencymarker = new google.maps.Marker({
                position: position,
                map: map,
                icon: 'resources/images/border-dot-point-25.png',
            });
            
            google.maps.event.addListener(emergencymarker, 'click', function() {
                if (confirm("do you want to delete this?")) {
                    path.coordinates.splice(location.id, 1)
                    removeMarker(position)
                }
            });
            
            console.log("position: "+position);
            emergency_marker.push(position);
        }
        
        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBymq4YRMhZoMwnPUd2SfyzQQLEvUtafkM&libraries=places&callback=initMap"
    async defer></script>
</body>
</html>
