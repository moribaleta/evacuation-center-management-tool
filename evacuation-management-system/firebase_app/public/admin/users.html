<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Public Users</title>
    
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.19.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.19.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.19.1/firebase-database.js"></script>
    <script defer src="/__/firebase/7.19.1/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.19.1/firebase-storage.js"></script>
    <script defer src="/__/firebase/7.19.1/firebase-firestore.js"></script>
    <script defer src="/__/firebase/7.19.1/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery-3.0.0.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <link href="css/main-style.css" rel="stylesheet">
    <script src="js/vue.js"></script>
    <script src="../_global/js/objects.js"></script>
    <script src="../_global/js/utilities.js"></script>
    
    
</head>

<body>
    <div class="sidenav" id="header" attr="users">
        <div class="sidenav-item">
            <img class="nav-image" :src="logo" />
        </div>
        
        <div  v-for="item in header_items" v-bind:class="'sidenav-item ' + (active == item.id ? 'active' : '') ">
            <a v-bind:href="item.href">
                <div class="icon-block">
                    <i class="material-icons">{{item.icon}}</i>
                    <h5 class="center">{{item.title}}</h5>
                </div>
            </a>
        </div>
        
        <div class="sidenav-item">
            <a v-on:click="onLogout()">
                <div class="icon-block">
                    <i class="material-icons">close</i>
                    <h5 class="center">Log Out</h5>
                </div>
            </a>
        </div>
    </div>
    <div class="container" id="content">
        <div id="userModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">{{isEdit ? 'Edit ': 'Add '}} Account</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col col-md-12 input-container" v-for="key in formModelHeaders">
                                <p>{{formModel[key].title}}</p>
                                
                                <input v-if="formModel[key].type == 'text'" type="text" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'password'" type="password" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'email'" type="email" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'number'" type="number" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'date'" type="date" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'datetime'" type="datetime" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <textarea v-if="formModel[key].type == 'textarea'" class="form-control"
                                :id="'input_'+key" name="exact_address" v-model="data_input[key]"></textarea>
                                
                                <select v-if="formModel[key].type == 'dropdown'" class="input input-item input-select" :id="'input_'+key" 
                                v-model="data_input[key]">
                                <option v-for="option in formModel[key].options" :value="option.value">
                                    {{option.title}}</option>
                                </select>
                            </div>  
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"
                        v-on:click="onSaveUser()">Save</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <div id="dependentModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">{{isEdit ? 'Edit ': 'Add '}} Dependent Account</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col col-md-12 input-container" v-for="key in dependentsHeaders">
                                <p>{{formModel[key].title}}</p>
                                
                                <input v-if="formModel[key].type == 'text'" type="text" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'password'" type="password" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'email'" type="email" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'number'" type="number" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'date'" type="date" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <input v-if="formModel[key].type == 'datetime'" type="datetime" class="input input-item"
                                :id="'input_'+key" v-model="data_input[key]">
                                
                                <textarea v-if="formModel[key].type == 'textarea'" class="form-control"
                                :id="'input_'+key" name="exact_address" v-model="data_input[key]"></textarea>
                                
                                <select v-if="formModel[key].type == 'dropdown'" class="input input-item input-select" :id="'input_'+key" 
                                v-model="data_input[key]">
                                <option v-for="option in formModel[key].options" :value="option.value">
                                    {{option.title}}</option>
                                </select>
                            </div>  
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"
                        v-on:click="onSaveDependent()">Save</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <h1>Public Users</h1>
        
        <h3>Users</h3>
        <div class="loader-container" v-if="isLoading">
            <div class="loader"></div>
        </div>
        <div class="section" v-if="!isLoading">
            <div class="table-container" id="tableData">
                <div class="well" v-for="item,index in user_list">
                    <div class="row">
                        <div class="col col-xs-12 item-info">
                            <p class="item-label">
                                {{index + 1}}.
                            </p>
                        </div>
                        <div class="col col-xs-4 item-info" v-for="key,index in headers" v-if="key !='id'">
                            <p class="item-label">
                                {{key}}:
                            </p>
                            <p class="item-value">
                                {{item[key]}}
                            </p>
                        </div>
                        
                        <div class="col col-xs-12">
                            <button class="btn btn-default btn-info" :href="'#dependentrow'+index" data-toggle="collapse">View Dependents</button>
                            <button class="btn btn-default btn-info" v-on:click="editItem(index)">edit</button>
                            <button class="btn btn-default btn-danger" v-on:click="deleteItem(index)">delete</button>
                        </div>
                    </div>
                    
                    <div :id="'dependentrow'+index" class="panel-collapse collapse">
                        <div class="panel-body">
                            <ul class="list-group">
                                <li class="list-group-item"  v-if="!item.dependents || item.dependents.length <= 0">
                                    <p>No Dependents</p>
                                </li>
                                
                                <li class="list-group-item" v-for="dependent,index in item.dependents">
                                    <!-- <img :src="cdn+image" class="img-thumbnail img-grid"/> -->
                                    <div class="row">
                                        <div class="col col-xs-4 item-info" v-for="key,index in dependentsHeaders" v-if="key !='id'">
                                            <p class="item-label">
                                                {{formModel[key].title}}:
                                            </p>
                                            <p class="item-value">
                                                {{dependent.get(key)}}
                                            </p>
                                        </div>
                                        <div class="col col-xs-12">
                                            <button class="btn btn-default btn-info" v-on:click="onEditDependent(item.id,index)">edit</button>
                                            <button class="btn btn-default btn-danger" v-on:click="onDeleteDependent(item.id, index)">delete</button>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="panel-footer">
                            <div class="row">
                                <button class="btn btn-default btn-info" v-on:click="addNewDependent(index)">Add New Dependent</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="section">
            <div class="button-container">
                <button type="button" id="add-report" class="btn btn-info button-view"
                v-on:click="onAddNewUser()">add User
            </button>
        </div>
    </div>
</div>

<script src="js/app/datahandler.js"></script>
<script src="js/app/constants.js"></script>
<script src="js/app/app.js"></script>
<script>
    
    app = new Vue({
        el: '#content',
        data: {
            user: new AdminUser(),
            user_list: [],
            data_input: {},
            dependents: [],
            
            headers: Object.keys(PublicUser.headers),
            formModelHeaders: Object.keys(PublicUser.formModel),
            formModel: PublicUser.formModel,
            dependentsHeaders: PublicUser.formDependent,
            isEdit: false,
            editUserId: null,
            municipalities: [],
            isLoading : false,
        },
        methods: {
            onStart(){
                this.user = header.user
                this.municipalities = municipalities
                this.formModel.municipality.options = municipalities.map((municipal) => {
                    return {title: municipal, value: municipal}
                })

                this.fetchUser()
            },
            fetchUser() {
                this.isLoading = true
                DataHandler.getPublicUsers(this.user.municipality).then((message) => {
                    this.setUser(message.data)
                }).catch(err => {
                    console.log(err)
                }).finally(() => {
                    this.isLoading = false
                })
            },
            
            setUser(data) {
                this.user_list = data
                console.log("userlist %o",this.user_list)
            },
            
            onAddNewUser() {    
                this.data_input = (new PublicUser()).toObject()
                this.data_input.created_by = this.user.id
                this.isEdit = false
                $('#userModal').modal()
            },
            
            editItem(index) {
                const user      = this.user_list[index]
                this.isEdit     = true
                this.data_input = user.toObject()
                this.data_input.date_updated = new Date()
                $('#userModal').modal()
            },
            
            onSaveUser() {
                const input = PublicUser.parse(this.data_input)
                
                DataHandler.addPublicUser(input).then((data) => {
                    if (data.error) {
                        alert(`Can't Save User: ${data.error}`)
                    } else {
                        alert(`User Have Been Saved Successfuly`)
                        this.fetchUser()
                    }
                }).catch(error =>{
                    console.log(error)
                })
            },
            
            
            deleteItem(index) {
                /*  deleteUser(this.user_list[index].id, this.initApp) */
                let onConfirm = confirm('Deleting User\nPress confirm to proceed')
                if (onConfirm) {
                    DataHandler.deletePublicUser(this.user_list[index].id).then((data) => {
                        console.log(data)
                        if (data.error) {
                            alert(`Can't Delete User ${data.error}`)
                        } else {
                            alert(`User Have Been Deleted Successfuly`)
                            this.fetchUser()
                        }
                    })
                }
                
            },
        }
    })
    
    /* $(document).ready(() => {
        header.onStart()
    }) */
</script>

</body>

</html>